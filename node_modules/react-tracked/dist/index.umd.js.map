{"version":3,"file":"index.umd.js","sources":["../src/utils.ts","../src/createTrackedSelector.ts","../src/createContainer.ts","../src/memo.ts"],"sourcesContent":["import { useEffect, useRef, useDebugValue } from 'react';\nimport { affectedToPathList } from 'proxy-compare';\n\ntype Obj = Record<string, unknown>;\n\nexport const useAffectedDebugValue = <State>(\n  state: State,\n  affected: WeakMap<Obj, unknown>,\n) => {\n  const pathList = useRef<(string | number | symbol)[][]>();\n  useEffect(() => {\n    pathList.current = affectedToPathList(state, affected);\n  });\n  useDebugValue(state);\n};\n","import {\n  useCallback,\n  useEffect,\n  useMemo,\n  useReducer,\n  useRef,\n} from 'react';\nimport { createProxy, isChanged } from 'proxy-compare';\n\nimport { useAffectedDebugValue } from './utils';\n\nexport const createTrackedSelector = <State>(\n  useSelector: <Selected>(selector: (state: State) => Selected) => Selected,\n) => {\n  const useTrackedSelector = () => {\n    const [, forceUpdate] = useReducer((c) => c + 1, 0);\n    const affected = new WeakMap();\n    const lastAffected = useRef<typeof affected>();\n    const prevState = useRef<State>();\n    const lastState = useRef<State>();\n    useEffect(() => {\n      lastAffected.current = affected;\n      if (prevState.current !== lastState.current\n        && isChanged(\n          prevState.current,\n          lastState.current,\n          affected,\n          new WeakMap(),\n        )) {\n        prevState.current = lastState.current;\n        forceUpdate();\n      }\n    });\n    const selector = useCallback((nextState: State) => {\n      lastState.current = nextState;\n      if (prevState.current\n        && prevState.current !== nextState\n        && lastAffected.current\n        && !isChanged(\n          prevState.current,\n          nextState,\n          lastAffected.current,\n          new WeakMap(),\n        )\n      ) {\n        // not changed\n        return prevState.current;\n      }\n      prevState.current = nextState;\n      return nextState;\n    }, []);\n    const state = useSelector(selector);\n    if (typeof process === 'object' && process.env.NODE_ENV !== 'production') {\n      // eslint-disable-next-line react-hooks/rules-of-hooks\n      useAffectedDebugValue(state, affected);\n    }\n    const proxyCache = useMemo(() => new WeakMap(), []); // per-hook proxyCache\n    return createProxy(state, affected, proxyCache);\n  };\n  return useTrackedSelector;\n};\n","/* eslint react/destructuring-assignment: off */\n\nimport {\n  ComponentType,\n  Context as ContextOrig,\n  ReactNode,\n  createContext as createContextOrig,\n  createElement,\n  useCallback,\n  useContext as useContextOrig,\n  useDebugValue,\n} from 'react';\n\nimport {\n  Context,\n  createContext,\n  useContextSelector,\n  useContextUpdate,\n} from 'use-context-selector';\n\nimport { createTrackedSelector } from './createTrackedSelector';\n\ntype AnyFunction = (...args: any[]) => any;\ntype Options<State, Update extends AnyFunction> = {\n  defaultState?: State;\n  defaultUpdate?: Update;\n  stateContextName?: string;\n  updateContextName?: string;\n  concurrentMode?: boolean;\n}\n/**\n * [Deprecated] Please use object option\n */\ntype DeprecatedOption = boolean\n\nexport const createContainer = <State, Update extends AnyFunction, Props>(\n  useValue: (props: Props) => readonly [State, Update],\n  options?: Options<State, Update> | DeprecatedOption,\n) => {\n  if (typeof options === 'boolean') {\n    // eslint-disable-next-line no-console\n    console.warn('boolean option is deprecated, please specify { concurrentMode: true }');\n    options = { concurrentMode: options };\n  }\n  const {\n    stateContextName = 'StateContainer',\n    updateContextName = 'UpdateContainer',\n    concurrentMode,\n  } = options || {};\n  const StateContext = createContext<State | undefined>(options?.defaultState);\n  const UpdateContext = createContextOrig<Update | undefined>(options?.defaultUpdate);\n  StateContext.displayName = stateContextName;\n  UpdateContext.displayName = updateContextName;\n\n  const Provider = (props: Props & { children: ReactNode }) => {\n    const [state, update] = useValue(props);\n    return createElement(\n      UpdateContext.Provider,\n      { value: update },\n      createElement(StateContext.Provider as ComponentType<{\n        value: State;\n      }>, { value: state }, props.children),\n    );\n  };\n\n  const useSelector = <Selected>(\n    selector: (state: State) => Selected,\n  ) => {\n    if (\n      typeof process === 'object'\n      && process.env.NODE_ENV !== 'production'\n    ) {\n      const selectorOrig = selector;\n      selector = (state: State) => {\n        if (state === undefined) {\n          throw new Error('Please use <Provider>');\n        }\n        return selectorOrig(state);\n      };\n    }\n    const selected = useContextSelector(StateContext as Context<State>, selector);\n    useDebugValue(selected);\n    return selected;\n  };\n\n  const useTrackedState = createTrackedSelector(useSelector);\n\n  const useUpdate = concurrentMode\n    ? () => {\n      if (\n        typeof process === 'object'\n        && process.env.NODE_ENV !== 'production'\n        && useContextOrig(UpdateContext) === undefined\n      ) {\n        throw new Error('Please use <Provider>');\n      }\n      const contextUpdate = useContextUpdate(StateContext as Context<unknown>);\n      const update = useContextOrig(UpdateContext as ContextOrig<Update>);\n      return useCallback((...args: Parameters<Update>) => {\n        let result: ReturnType<Update> | undefined;\n        contextUpdate(() => {\n          result = update(...args);\n        });\n        return result as ReturnType<Update>;\n      }, [contextUpdate, update]);\n    }\n    // not concurrentMode\n    : () => {\n      if (\n        typeof process === 'object'\n        && process.env.NODE_ENV !== 'production'\n        && useContextOrig(UpdateContext) === undefined\n      ) {\n        throw new Error('Please use <Provider>');\n      }\n      return useContextOrig(UpdateContext as ContextOrig<Update>);\n    };\n\n  const useTracked = () => [useTrackedState(), useUpdate()] as [\n    ReturnType<typeof useTrackedState>,\n    ReturnType<typeof useUpdate>,\n  ];\n\n  return {\n    Provider,\n    useTrackedState,\n    useTracked,\n    useUpdate,\n    useSelector,\n  } as const;\n};\n","import { createElement, memo as reactMemo, forwardRef } from 'react';\nimport { trackMemo } from 'proxy-compare';\n\nimport type {\n  PropsWithChildren,\n  NamedExoticComponent,\n  ComponentType,\n  ComponentProps,\n  MemoExoticComponent,\n} from 'react';\n\nexport function memo<P extends Record<string, unknown>>(\n  Component: ComponentType<P>,\n  propsAreEqual?: (\n    prevProps: Readonly<PropsWithChildren<P>>,\n    nextProps: Readonly<PropsWithChildren<P>>,\n  ) => boolean,\n): NamedExoticComponent<P>;\n\nexport function memo<T extends ComponentType<any>>(\n  Component: T,\n  propsAreEqual?: (\n    prevProps: Readonly<ComponentProps<T>>,\n    nextProps: Readonly<ComponentProps<T>>,\n  ) => boolean,\n): MemoExoticComponent<T>;\n\nexport function memo(Component: any, propsAreEqual?: any) {\n  const WrappedComponent = forwardRef((props: any, ref: any) => {\n    Object.values(props).forEach(trackMemo);\n    return createElement(Component, { ...props, ref });\n  });\n  return reactMemo(WrappedComponent, propsAreEqual);\n}\n"],"names":["useAffectedDebugValue","state","affected","pathList","useRef","useEffect","current","affectedToPathList","useDebugValue","createTrackedSelector","useSelector","useTrackedSelector","_useReducer","useReducer","c","forceUpdate","WeakMap","lastAffected","prevState","lastState","isChanged","selector","useCallback","nextState","process","env","NODE_ENV","proxyCache","useMemo","createProxy","createContainer","useValue","options","_options","_options2","console","warn","concurrentMode","_ref","_ref$stateContextName","stateContextName","_ref$updateContextNam","updateContextName","StateContext","createContext","defaultState","UpdateContext","createContextOrig","defaultUpdate","displayName","Provider","props","_useValue","update","createElement","value","children","selectorOrig","undefined","Error","selected","useContextSelector","useTrackedState","useUpdate","useContextOrig","contextUpdate","useContextUpdate","_arguments","arguments","result","apply","slice","call","useTracked","memo","Component","propsAreEqual","WrappedComponent","forwardRef","ref","Object","values","forEach","trackMemo","_extends","reactMemo"],"mappings":"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"}